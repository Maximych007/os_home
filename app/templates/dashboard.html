{% extends "base.html" %}

{% block title %}Главная — Server UI{% endblock %}

{% block content %}
<section class="hero hero--compact">
  <div>
    <h1 class="hero__title">Главный экран</h1>
    <p class="hero__subtitle">Плитки обновляются каждые 3 секунды.</p>
  </div>

  <div class="hero__actions">
    <button class="iconbtn iconbtn--gear" id="btnGear" type="button" title="Настройки плиток">⚙</button>

    <button class="btn btn--primary" id="btnSave" type="button" hidden>Сохранить</button>
    <button class="btn btn--ghost" id="btnCancel" type="button" hidden>Отмена</button>

    <div class="addbox" id="addBox" hidden>
      <select class="select" id="addSelect">
        <option value="">+ Добавить плитку…</option>
      </select>
      <button class="btn btn--ghost" id="btnAdd" type="button">Добавить</button>
    </div>
  </div>
</section>

<section class="tiles" id="tilesGrid">
  {% for t in tiles %}
    <article class="tile" data-tile="{{ t.id }}">
      <div class="tile__head">
        <h3 class="tile__title">{{ t.title }}</h3>

        <div class="tile__controls" hidden>
          <span class="handle" title="Перетащить">⋮⋮</span>
          <button class="iconbtn iconbtn--danger" data-action="remove" type="button" title="Убрать">✕</button>
        </div>
      </div>

      <div class="tile__value">
        <span class="tile__number" data-role="value">{{ t.value }}</span>
        <span class="tile__unit" data-role="unit">{{ t.unit }}</span>
      </div>

      <div class="tile__sub" data-role="sub">
        {{ t.sub if t.sub else "—" }}
      </div>

      <div class="tile__lines" data-role="lines" {% if not t.lines %}hidden{% endif %}>
        {% if t.lines %}
          {% for d in t.lines %}
            <div class="kv">
              <div class="kv__row">
                <div class="kv__k">{{ d.label }}</div>
                <div class="kv__v">
                  <span class="kv__used">{{ d.used_gb }}</span>/<span class="kv__total">{{ d.total_gb }}</span> GB
                  <span class="kv__pct">({{ d.pct }}%)</span>
                </div>
              </div>
              <div class="kv__bar">
                <div class="kv__barFill" style="width: {{ d.pct }}%"></div>
              </div>
            </div>
          {% endfor %}
        {% endif %}
      </div>

      {% if t.pct is not none %}
        <div class="bar" aria-label="usage bar">
          <div class="bar__fill" data-role="bar" style="width: {{ t.pct }}%"></div>
        </div>
      {% endif %}
    </article>
  {% endfor %}
</section>

<section class="grid grid--2">
  <div class="card">
    <h2 class="card__title">Сервисы</h2>
    <p class="card__text">Переход к установке приложений и системным настройкам.</p>
    <div class="actions">
      <a class="btn btn--primary" href="/apps">Приложения</a>
      <a class="btn btn--ghost" href="/system">Система</a>
    </div>
  </div>

  <div class="card">
    <h2 class="card__title">Docker</h2>
    {% if docker_present %}
      <p class="card__text">Docker обнаружен. Установка приложений доступна.</p>
    {% else %}
      <p class="card__text muted">Docker не найден. Раздел «Приложения» будет в режиме просмотра.</p>
    {% endif %}
    <div class="actions">
      <a class="btn btn--ghost" href="/apps">Открыть «Приложения»</a>
    </div>
  </div>
</section>

<section class="card">
  <h2 class="card__title">Приложения</h2>

  {% if installed_apps_cards|length == 0 %}
    <p class="card__text muted">Пока ничего не установлено. Перейдите в «Приложения».</p>
    <div class="actions">
      <a class="btn btn--primary" href="/apps">Открыть «Приложения»</a>
    </div>
  {% else %}
    <div class="appgrid">
      {% for a in installed_apps_cards %}
        <a class="appshot" href="{{ a.url if a.url else '/apps' }}" target="_blank" rel="noreferrer">
          <div class="appshot__icon">
            <img class="appshot__img" src="{{ a.icon_url }}" alt="{{ a.title }}">
          </div>
          <div class="appshot__label">{{ a.title }}</div>
        </a>
      {% endfor %}
    </div>

    <div class="actions">
      <a class="btn btn--ghost" href="/apps">Управление приложениями</a>
    </div>
  {% endif %}
</section>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
<script>
(function () {
  const INTERVAL_MS = 3000;

  const grid = document.getElementById("tilesGrid");
  const btnGear = document.getElementById("btnGear");
  const btnSave = document.getElementById("btnSave");
  const btnCancel = document.getElementById("btnCancel");
  const addBox = document.getElementById("addBox");
  const addSelect = document.getElementById("addSelect");
  const btnAdd = document.getElementById("btnAdd");

  let editMode = false;
  let initialOrder = Array.from(grid.querySelectorAll(".tile")).map(t => t.dataset.tile);

  function clampPct(v) {
    v = Number(v);
    if (!Number.isFinite(v)) return null;
    return Math.max(0, Math.min(100, v));
  }

  function getOrderFromDOM() {
    return Array.from(grid.querySelectorAll(".tile")).map(t => t.dataset.tile);
  }

  async function refreshAddSelect() {
    try {
      const cfg = await (await fetch("/api/tiles/config", { cache: "no-store" })).json();
      if (!cfg.ok && cfg.redirect) { window.location.href = cfg.redirect; return; }

      const current = new Set(getOrderFromDOM());
      const available = (cfg.available || []);

      addSelect.innerHTML = `<option value="">+ Добавить плитку…</option>`;
      available.forEach(t => {
        if (!current.has(t.id)) {
          const opt = document.createElement("option");
          opt.value = t.id;
          opt.textContent = t.title;
          addSelect.appendChild(opt);
        }
      });
    } catch (e) {}
  }

  function setEditMode(on) {
    editMode = on;

    btnSave.hidden = !on;
    btnCancel.hidden = !on;
    addBox.hidden = !on;

    grid.querySelectorAll(".tile").forEach(tile => {
      tile.classList.toggle("tile--draggable", on);
      const controls = tile.querySelector(".tile__controls");
      if (controls) controls.hidden = !on;
    });

    sortable.option("disabled", !on);

    if (on) {
      initialOrder = getOrderFromDOM();
      refreshAddSelect();
    }
  }

  function ensureLinesContainer(tileEl) {
    let lines = tileEl.querySelector('[data-role="lines"]');
    if (!lines) {
      lines = document.createElement("div");
      lines.className = "tile__lines";
      lines.setAttribute("data-role", "lines");
      tileEl.appendChild(lines);
    }
    return lines;
  }

  function renderDiskLines(linesEl, items) {
    if (!items || !items.length) {
      linesEl.hidden = true;
      linesEl.innerHTML = "";
      return;
    }
    linesEl.hidden = false;
    linesEl.innerHTML = "";
    items.forEach(d => {
      const pct = clampPct(d.pct) ?? 0;
      const row = document.createElement("div");
      row.className = "kv";
      row.innerHTML = `
        <div class="kv__row">
          <div class="kv__k"></div>
          <div class="kv__v">
            <span class="kv__used"></span>/<span class="kv__total"></span> GB
            <span class="kv__pct"></span>
          </div>
        </div>
        <div class="kv__bar"><div class="kv__barFill" style="width:${pct}%"></div></div>
      `;
      row.querySelector(".kv__k").textContent = d.label ?? "—";
      row.querySelector(".kv__used").textContent = d.used_gb ?? "—";
      row.querySelector(".kv__total").textContent = d.total_gb ?? "—";
      row.querySelector(".kv__pct").textContent = `(${d.pct ?? "—"}%)`;
      linesEl.appendChild(row);
    });
  }

  function updateTile(tile) {
    const el = grid.querySelector(`[data-tile="${tile.id}"]`);
    if (!el) return;

    const valueEl = el.querySelector(`[data-role="value"]`);
    const unitEl  = el.querySelector(`[data-role="unit"]`);
    const subEl   = el.querySelector(`[data-role="sub"]`);
    const barEl   = el.querySelector(`[data-role="bar"]`);

    if (valueEl) valueEl.textContent = tile.value ?? "—";
    if (unitEl)  unitEl.textContent  = tile.unit ?? "";
    if (subEl)   subEl.textContent   = tile.sub ?? "—";

    if (barEl) {
      const pct = clampPct(tile.pct);
      barEl.style.width = (pct === null) ? "0%" : (pct + "%");
    }

    const linesEl = ensureLinesContainer(el);
    renderDiskLines(linesEl, tile.lines || []);
  }

  async function refreshTiles() {
    try {
      const r = await fetch("/api/tiles", { cache: "no-store" });
      const data = await r.json();

      if (!data.ok && data.redirect) {
        window.location.href = data.redirect;
        return;
      }

      (data.tiles || []).forEach(updateTile);
    } catch (e) {}
  }

  function createTileElement(tileId, titleText) {
    const el = document.createElement("article");
    el.className = "tile";
    el.dataset.tile = tileId;
    el.innerHTML = `
      <div class="tile__head">
        <h3 class="tile__title"></h3>
        <div class="tile__controls" hidden>
          <span class="handle" title="Перетащить">⋮⋮</span>
          <button class="iconbtn iconbtn--danger" data-action="remove" type="button" title="Убрать">✕</button>
        </div>
      </div>

      <div class="tile__value">
        <span class="tile__number" data-role="value">—</span>
        <span class="tile__unit" data-role="unit"></span>
      </div>

      <div class="tile__sub" data-role="sub">—</div>
      <div class="tile__lines" data-role="lines" hidden></div>
    `;
    el.querySelector(".tile__title").textContent = titleText || tileId;

    if (editMode) {
      el.classList.add("tile--draggable");
      const controls = el.querySelector(".tile__controls");
      if (controls) controls.hidden = false;
    }
    return el;
  }

  async function saveConfig() {
    const order = getOrderFromDOM();
    const r = await fetch("/api/tiles/config", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ order })
    });
    const data = await r.json();
    if (!data.ok && data.redirect) {
      window.location.href = data.redirect;
      return false;
    }
    return !!data.ok;
  }

  const sortable = new Sortable(grid, {
    animation: 180,
    easing: "cubic-bezier(0.2, 0.8, 0.2, 1)",
    handle: ".handle",
    draggable: ".tile",
    ghostClass: "tile--ghost",
    chosenClass: "tile--chosen",
    dragClass: "tile--drag",
    disabled: true
  });

  btnGear.addEventListener("click", () => setEditMode(!editMode));

  btnCancel.addEventListener("click", () => {
    const byId = new Map();
    Array.from(grid.querySelectorAll(".tile")).forEach(el => byId.set(el.dataset.tile, el));
    grid.innerHTML = "";
    initialOrder.forEach(id => {
      const el = byId.get(id);
      if (el) grid.appendChild(el);
    });
    setEditMode(false);
    refreshTiles();
  });

  btnSave.addEventListener("click", async () => {
    const ok = await saveConfig();
    if (ok) {
      setEditMode(false);
      refreshTiles();
    }
  });

  btnAdd.addEventListener("click", async () => {
    const id = addSelect.value;
    if (!id) return;

    let title = id;
    try {
      const cfg = await (await fetch("/api/tiles/config", { cache: "no-store" })).json();
      const found = (cfg.available || []).find(x => x.id === id);
      if (found) title = found.title;
    } catch (e) {}

    const el = createTileElement(id, title);
    grid.appendChild(el);

    await refreshAddSelect();
    await refreshTiles();
  });

  grid.addEventListener("click", async (e) => {
    if (!editMode) return;
    const btn = e.target.closest("[data-action='remove']");
    if (!btn) return;
    const tile = btn.closest(".tile");
    if (!tile) return;
    tile.remove();
    await refreshAddSelect();
  });

  refreshTiles();
  setInterval(() => { if (!editMode) refreshTiles(); }, INTERVAL_MS);
})();
</script>
{% endblock %}
