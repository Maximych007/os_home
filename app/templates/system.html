{% extends "base.html" %}
{% block title %}Система{% endblock %}
{% block content %}
<div class="container">
    <h2>Система</h2>
    
    <div class="card">
        <h3>Версия</h3>
        <p><strong>Текущая версия:</strong> {{ current_version }}</p>
        {% if update_available %}
        <p class="alert alert-info">✨ Доступна новая версия</p>
        {% endif %}
    </div>

    <div class="card">
        <h3>Обновления</h3>
        <button id="check-btn" class="btn">Проверить обновления</button>
        <button id="update-btn" class="btn btn-primary" {% if not update_available %}disabled{% endif %}>
            Обновить
        </button>
        <pre id="output" style="margin-top: 1rem; background: #f5f5f5; padding: 1rem; border-radius: 4px; display: none;"></pre>
    </div>
</div>

<script>
const checkBtn = document.getElementById('check-btn');
const updateBtn = document.getElementById('update-btn');
const output = document.getElementById('output');

checkBtn.addEventListener('click', async () => {
    checkBtn.disabled = true;
    checkBtn.textContent = 'Проверка...';
    output.style.display = 'block';
    output.textContent = 'Выполняется проверка обновлений...';
    
    const res = await fetch('/system/check', { method: 'POST' });
    const data = await res.json();
    
    if (data.status === 'ok') {
        output.textContent = data.output;
        // перезагрузить страницу чтобы обновить статус
        setTimeout(() => location.reload(), 1500);
    } else {
        output.textContent = 'Ошибка: ' + data.message;
    }
    checkBtn.disabled = false;
    checkBtn.textContent = 'Проверить обновления';
});

updateBtn.addEventListener('click', async () => {
    if (!confirm('Применить обновление? Сервис будет перезапущен.')) return;
    
    updateBtn.disabled = true;
    updateBtn.textContent = 'Обновление...';
    output.style.display = 'block';
    output.textContent = 'Применяется обновление (может занять несколько минут)...';
    
    const res = await fetch('/system/update', { method: 'POST' });
    const data = await res.json();
    
    if (data.status === 'ok') {
        output.textContent = data.output + '\n\nОбновление завершено, страница перезагрузится...';
        setTimeout(() => location.reload(), 3000);
    } else {
        output.textContent = 'Ошибка: ' + data.message;
        updateBtn.disabled = false;
        updateBtn.textContent = 'Обновить';
    }
});
</script>
{% endblock %}
